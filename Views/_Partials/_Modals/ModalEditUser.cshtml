@* <!-- Edit User Modal -->
<div class="modal fade" id="editUser" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-simple modal-edit-user">
    <div class="modal-content">
      <div class="modal-body">
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        <div class="text-center mb-6">
          <h4 class="mb-2">Edit User Information</h4>
          <p>Updating user details will receive a privacy audit.</p>
        </div>
        <form id="editUserForm" class="row g-6" onsubmit="return false">
          <div class="col-12 col-md-6">
            <label class="form-label" for="modalEditUserFirstName">First Name</label>
            <input type="text" id="modalEditUserFirstName" name="modalEditUserFirstName" class="form-control" placeholder="John" value="John" />
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label" for="modalEditUserMiddleName">Middle Name</label>
            <input type="text" id="modalEditUserMiddleName" name="modalEditUserMiddleName" class="form-control" placeholder="Doe" value="Doe" />
          </div>
          <div class="col-12">
            <label class="form-label" for="modalEditLastName">Last Name</label>
            <input type="text" id="modalEditLastName" name="modalEditLastName" class="form-control" placeholder="johndoe007" value="johndoe007" />
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label" for="modalEditUserEmail">Email</label>
            <input type="text" id="modalEditUserEmail" name="modalEditUserEmail" class="form-control" placeholder="example&#64;domain.com" value="example&#64;domain.com" />
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label" for="modalEditUserStatus">Role</label>
            <select id="modalEditUserStatus" name="modalEditUserStatus" class="select2 form-select" aria-label="Default select example">
              <option selected>Role</option>
              <option value="admin">Admin</option>
              <option value="affiliate">Affiliate</option>
              <option value="customer">Cusotmer</option>
            </select>
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label" for="modalEditTaxID">Tax ID</label>
            <input type="text" id="modalEditTaxID" name="modalEditTaxID" class="form-control modal-edit-tax-id" placeholder="123 456 7890" value="123 456 7890" />
          </div> 
          <div class="col-12 col-md-6">
            <label class="form-label" for="modalEditUserPhone">Phone Number</label>
            <div class="input-group">
              <span class="input-group-text">Leb (+961)</span>
              <input type="text" id="modalEditUserPhone" name="modalEditUserPhone" class="form-control phone-number-mask" placeholder="76 854 235" value="" />
            </div>
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label" for="modalEditUserLanguage">Language</label>
            <select id="modalEditUserLanguage" name="modalEditUserLanguage" class="select2 form-select" multiple>
              <option value="">Select</option>
              <option value="english" selected>English</option>
              <option value="spanish">Spanish</option>
              <option value="french">French</option>
              <option value="german">German</option>
              <option value="dutch">Dutch</option>
              <option value="hebrew">Hebrew</option>
              <option value="sanskrit">Sanskrit</option>
              <option value="hindi">Hindi</option>
            </select>
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label" for="modalEditUserCountry">Country</label>
            <select id="modalEditUserCountry" name="modalEditUserCountry" class="select2 form-select" data-allow-clear="true">
              <option value="">Select</option>
              <option value="Australia">Australia</option>
              <option value="Bangladesh">Bangladesh</option>
              <option value="Belarus">Belarus</option>
              <option value="Brazil">Brazil</option>
              <option value="Canada">Canada</option>
              <option value="China">China</option>
              <option value="France">France</option>
              <option value="Germany">Germany</option>
              <option value="India" selected>India</option>
              <option value="Indonesia">Indonesia</option>
              <option value="Israel">Israel</option>
              <option value="Italy">Italy</option>
              <option value="Japan">Japan</option>
              <option value="Korea">Korea, Republic of</option>
              <option value="Mexico">Mexico</option>
              <option value="Philippines">Philippines</option>
              <option value="Russia">Russian Federation</option>
              <option value="South Africa">South Africa</option>
              <option value="Thailand">Thailand</option>
              <option value="Turkey">Turkey</option>
              <option value="Ukraine">Ukraine</option>
              <option value="United Arab Emirates">United Arab Emirates</option>
              <option value="United Kingdom">United Kingdom</option>
              <option value="United States">United States</option>
            </select>
          </div>
          <div class="col-12">
            <div class="form-check form-switch">
              <input type="checkbox" class="form-check-input" id="editBillingAddress" />
              <label for="editBillingAddress" class="switch-label">Use as a billing address?</label>
            </div>
          </div>
          <div class="col-12 text-center">
            <button type="submit" class="btn btn-primary me-3">Submit</button>
            <button type="reset" class="btn btn-label-secondary" data-bs-dismiss="modal" aria-label="Close">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
<!--/ Edit User Modal -->
 *@

<!-- Edit User Modal -->
<div class="modal fade" id="editUser" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-simple modal-edit-user">
        <div class="modal-content">
            <div class="modal-body">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                <div class="text-center mb-6">
                    <h4 class="mb-2">Edit User Information</h4>
                    <p>Updating user details will receive a privacy audit.</p>
                </div>
                <form id="editUserModalForm" class="row g-6" method="post">
                    @Html.AntiForgeryToken()
                    <input type="hidden" id="modalEditUserId" name="UserId">
                    <div class="col-12 col-md-6">
                        <label class="form-label" for="modalEditUserFirstName">First Name</label>
                        <input type="text" id="modalEditUserFirstName" name="FirstName" class="form-control" placeholder="John" required />
                    </div>
                    <div class="col-12 col-md-6">
                        <label class="form-label" for="modalEditUserMiddleName">Middle Name</label>
                        <input type="text" id="modalEditUserMiddleName" name="MiddleName" class="form-control" placeholder="M." />
                    </div>
                    <div class="col-12">
                        <label class="form-label" for="modalEditLastName">Last Name</label>
                        <input type="text" id="modalEditLastName" name="LastName" class="form-control" placeholder="Doe" required />
                    </div>
                    <div class="col-12 col-md-6">
                        <label class="form-label" for="modalEditUserEmail">Email</label>
                        <input type="email" id="modalEditUserEmail" name="Email" class="form-control" placeholder="example&#64;domain.com" required />
                    </div>
                    <div class="col-12 col-md-6">
                        <label class="form-label" for="modalEditUserStatus">Role</label>
                        <select id="modalEditUserStatus" name="Role" class="select2 form-select" required>
                            <option value="">Select</option>
                            <option value="Admin">Admin</option>
                            <option value="Affiliate">Affiliate</option>
                            <option value="Customer">Customer</option>
                        </select>
                    </div>
                    <div class="col-12 col-md-6">
                        <label class="form-label" for="modalEditUserPhone">Phone Number</label>
                        <div class="input-group">
                            <span class="input-group-text">Leb (+961)</span>
                            <input type="text" id="modalEditUserPhone" name="PhoneNumber" class="form-control phone-number-mask" placeholder="76 854 235" />
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="form-check form-switch">
                            <input type="checkbox" class="form-check-input" id="editBillingAddress" />
                            <label for="editBillingAddress" class="switch-label">Use as a billing address?</label>
                        </div>
                    </div>
                    <div class="col-12 mb-3">
                        <label class="form-label" for="modalEditVerificationPassword">Enter Password to Confirm Changes</label>
                        <div class="input-group input-group-merge">
                            <input type="password" id="modalEditVerificationPassword" class="form-control"
                                   placeholder="············" name="VerificationPassword" required />
                            <span class="input-group-text cursor-pointer toggle-password"><i class="ti ti-eye-off"></i></span>
                        </div>
                        <div class="form-text text-danger" id="modal-password-verification-error"></div>
                    </div>
                    <div class="col-12 text-center">
                        <button type="submit" class="btn btn-primary me-3">Submit</button>
                        <button type="reset" class="btn btn-label-secondary" data-bs-dismiss="modal" aria-label="Close">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<!--/ Edit User Modal -->

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Get the edit user modal element
        const editUserModal = document.getElementById('editUser');

        // Add event listener for when the modal is shown
        if (editUserModal) {
            editUserModal.addEventListener('show.bs.modal', function (event) {
                // Get the button that triggered the modal
                const button = event.relatedTarget;

                // Extract user ID from the current URL
                const urlParts = window.location.pathname.split('/');
                const userId = urlParts[urlParts.length - 1];

                if (userId) {
                    // Fetch user data
                    fetch(`/Users/GetUser?id=${userId}`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Failed to fetch user data');
                            }
                            return response.json();
                        })
                        .then(data => {
                            // Populate the edit form with user data
                            document.getElementById('modalEditUserId').value = data.userId;
                            document.getElementById('modalEditUserFirstName').value = data.firstName || '';
                            document.getElementById('modalEditUserMiddleName').value = data.middleName || '';
                            document.getElementById('modalEditLastName').value = data.lastName || '';
                            document.getElementById('modalEditUserEmail').value = data.email || '';
                            document.getElementById('modalEditUserPhone').value = data.phoneNumber || '';

                            // Set the role dropdown
                            const roleSelect = document.getElementById('modalEditUserStatus');
                            for (let i = 0; i < roleSelect.options.length; i++) {
                                if (roleSelect.options[i].value === data.role) {
                                    roleSelect.selectedIndex = i;
                                    break;
                                }
                            }

                            // Clear any previous error messages
                            document.getElementById('modal-password-verification-error').innerText = '';
                        })
                        .catch(error => {
                            console.error('Error fetching user data:', error);
                            alert('Failed to load user data. Please try again.');
                        });
                }
            });
        }

        // Handle form submission
        const editUserForm = document.getElementById('editUserModalForm');
        if (editUserForm) {
            editUserForm.addEventListener('submit', function(event) {
                event.preventDefault();

                const formData = new FormData(this);

                fetch('/Users/UpdateUser', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Show success message
                        Swal.fire({
                            title: 'Success!',
                            text: 'User updated successfully!',
                            icon: 'success',
                            customClass: {
                                confirmButton: 'btn btn-primary'
                            },
                            buttonsStyling: false
                        }).then(() => {
                            // Close modal and reload page
                            const modal = bootstrap.Modal.getInstance(document.getElementById('editUser'));
                            modal.hide();
                            window.location.reload();
                        });
                    } else {
                        // Show error message
                        document.getElementById('modal-password-verification-error').innerText = data.message;

                        if (data.message === "No changes detected." || data.message === "Incorrect password. Changes not saved.") {
                            // Don't close modal for these errors
                        } else {
                            Swal.fire({
                                title: 'Error!',
                                text: data.message,
                                icon: 'error',
                                customClass: {
                                    confirmButton: 'btn btn-primary'
                                },
                                buttonsStyling: false
                            });
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    Swal.fire({
                        title: 'Error!',
                        text: 'An error occurred while updating the user.',
                        icon: 'error',
                        customClass: {
                            confirmButton: 'btn btn-primary'
                        },
                        buttonsStyling: false
                    });
                });
            });
        }

        // Toggle password visibility
        const togglePasswordElements = document.querySelectorAll('.toggle-password');
        if (togglePasswordElements) {
            togglePasswordElements.forEach(element => {
                element.addEventListener('click', function() {
                    const input = this.parentNode.querySelector('input');
                    const icon = this.querySelector('i');

                    if (input.type === 'password') {
                        input.type = 'text';
                        icon.classList.remove('ti-eye-off');
                        icon.classList.add('ti-eye');
                    } else {
                        input.type = 'password';
                        icon.classList.remove('ti-eye');
                        icon.classList.add('ti-eye-off');
                    }
                });
            });
        }
    });
</script>
